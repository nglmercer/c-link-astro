---
import type { Link } from '../types/linktree';
import { getDomain, getPlatformIconName } from '../lib/profile';

interface Props {
  links: Link[];
}

const { links = [] } = Astro.props;
---

<div class="link-editor">
  <div class="editor-header">
    <h3>Links</h3>
    <span class="link-count">{links.length} / 10 links</span>
  </div>

  <div id="links-container" class="links-container" data-initial-links={JSON.stringify(links)}>
    {links.length === 0 ? (
      <div class="empty-state">
        <span class="material-symbols-outlined empty-icon">link_off</span>
        <p>No links yet</p>
        <span>Add your first link to get started</span>
      </div>
    ) : (
      links.map((link, index) => (
        <div class="link-card" data-id={link.id} data-index={index} draggable="true">
          <div class="link-card-header">
            <div class="drag-handle" title="Drag to reorder">
              <span class="material-symbols-outlined">drag_indicator</span>
            </div>
            <span class="link-number">#{index + 1}</span>
            <button class="btn-edit-link" data-id={link.id} title="Edit">
              <span class="material-symbols-outlined">edit</span>
            </button>
            <button class="btn-delete-link" data-id={link.id} title="Delete">
              <span class="material-symbols-outlined">delete</span>
            </button>
          </div>
          
          <div class="link-preview-mini">
            <div class="preview-icon">
              <span class="material-symbols-outlined">{getPlatformIconName(link.url)}</span>
            </div>
            <div class="preview-content">
              <span class="preview-title">{link.title}</span>
              <span class="preview-url">{getDomain(link.url)}</span>
            </div>
            <span class="material-symbols-outlined external-icon">open_in_new</span>
          </div>
        </div>
      ))
    )}
  </div>

  <button id="add-link-btn" class="add-link-btn">
    <span class="material-symbols-outlined">add</span>
    Add Link
  </button>

  <!-- Link Editor Modal -->
  <div id="link-modal" class="modal">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">Add Link</h3>
        <button id="close-modal" class="close-btn">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label for="link-title-input">Title</label>
          <input type="text" id="link-title-input" placeholder="My Website" />
        </div>
        
        <div class="form-group">
          <label for="link-url-input">URL</label>
          <input type="url" id="link-url-input" placeholder="https://example.com" />
        </div>
        
        <div class="link-preview-section">
          <label>Preview</label>
          <div class="preview-card">
            <div class="preview-card-icon" id="preview-card-icon">
              <span class="material-symbols-outlined">link</span>
            </div>
            <div class="preview-card-content">
              <span class="preview-card-title" id="preview-title-display">Link Title</span>
              <span class="preview-card-url" id="preview-url-display">https://example.com</span>
            </div>
            <span class="material-symbols-outlined external-arrow">open_in_new</span>
          </div>
        </div>
        
        <div class="form-group thumbnail-selection">
          <label>Thumbnail Type</label>
          <div class="thumbnail-options">
            <label class="thumbnail-option">
              <input type="radio" name="thumb-type" value="platform" checked />
              <div class="option-card">
                <span class="material-symbols-outlined">category</span>
                <span>Icon</span>
              </div>
            </label>
            <label class="thumbnail-option">
              <input type="radio" name="thumb-type" value="favicon" />
              <div class="option-card">
                <span class="material-symbols-outlined">language</span>
                <span>Favicon</span>
              </div>
            </label>
            <label class="thumbnail-option">
              <input type="radio" name="thumb-type" value="preview" />
              <div class="option-card">
                <span class="material-symbols-outlined">visibility</span>
                <span>Preview</span>
              </div>
            </label>
            <label class="thumbnail-option">
              <input type="radio" name="thumb-type" value="custom" />
              <div class="option-card">
                <span class="material-symbols-outlined">image</span>
                <span>Custom</span>
              </div>
            </label>
          </div>
        </div>

        <div id="custom-image-group" class="form-group" style="display: none;">
          <label for="link-image-input">Custom Image URL</label>
          <input type="url" id="link-image-input" placeholder="https://example.com/image.png" />
        </div>
        
        <div class="form-row">
          <label class="toggle-label">
            <input type="checkbox" id="link-active" checked />
            <span class="toggle-text">Active Link</span>
          </label>
        </div>
      </div>
      
      <div class="modal-footer">
        <button id="cancel-link-btn" class="btn-cancel">Cancel</button>
        <button id="save-link-btn" class="btn-save">Save Link</button>
      </div>
    </div>
  </div>

  <!-- Templates for dynamic rendering -->
  <template id="link-card-template">
    <div class="link-card" draggable="true">
      <div class="link-card-header">
        <div class="drag-handle" title="Drag to reorder">
          <span class="material-symbols-outlined">drag_indicator</span>
        </div>
        <span class="link-number"></span>
        <div class="header-actions">
          <button class="btn-edit-link" title="Edit">
            <span class="material-symbols-outlined">edit</span>
          </button>
          <button class="btn-delete-link" title="Delete">
            <span class="material-symbols-outlined">delete</span>
          </button>
        </div>
      </div>
      
      <div class="link-preview-mini">
        <div class="preview-icon">
          <span class="material-symbols-outlined"></span>
        </div>
        <div class="preview-content">
          <span class="preview-title"></span>
          <span class="preview-url"></span>
        </div>
        <span class="material-symbols-outlined external-icon">open_in_new</span>
      </div>
    </div>
  </template>

  <template id="empty-state-template">
    <div class="empty-state">
      <span class="material-symbols-outlined empty-icon">link_off</span>
      <p>No links yet</p>
      <span>Add your first link to get started</span>
    </div>
  </template>
</div>

<script>
  // dont apply lang="ts" to this script|| astro default script is ts 
  import type { Link } from '../types/linktree';

  import { getDomain, getFaviconUrl, getPlatformIconName } from '../lib/link-utils';

  // State
  let links: Link[] = [];
  let editingLinkId: string | null = null;
  let draggedItem: HTMLElement | null = null;

  // Initialize with data from server attribute
  const linksContainer = document.getElementById('links-container');
  if (linksContainer) {
    const rawLinks = linksContainer.getAttribute('data-initial-links');
    if (rawLinks) {
      try {
        links = JSON.parse(rawLinks);
        console.log('Initialized links:', links);
      } catch (e) {
        console.error('Error parsing initial links:', e);
      }
    }
  }

  // Modal elements
  const modal = document.getElementById('link-modal') as HTMLElement;
  const modalTitle = document.getElementById('modal-title');
  const titleInput = document.getElementById('link-title-input') as HTMLInputElement;
  const urlInput = document.getElementById('link-url-input') as HTMLInputElement;
  const imageInput = document.getElementById('link-image-input') as HTMLInputElement;
  const activeInput = document.getElementById('link-active') as HTMLInputElement;
  const thumbTypeInputs = document.querySelectorAll('input[name="thumb-type"]') as NodeListOf<HTMLInputElement>;
  const customImageGroup = document.getElementById('custom-image-group');
  
  const previewTitle = document.getElementById('preview-title-display');
  const previewUrl = document.getElementById('preview-url-display');
  const previewIcon = document.getElementById('preview-card-icon');



  // Open modal
  function openModal(linkId?: string) {
    if (!modal) return;
    
    if (linkId) {
      const link = links.find(l => l.id === linkId);
      if (link) {
        editingLinkId = linkId;
        if (modalTitle) modalTitle.textContent = 'Edit Link';
        if (titleInput) titleInput.value = link.title;
        if (urlInput) urlInput.value = link.url;
        if (imageInput) imageInput.value = link.thumbnailUrl || '';
        if (activeInput) activeInput.checked = link.isActive;
        
        const thumbType = link.thumbnailType || 'platform';
        thumbTypeInputs.forEach(input => {
          input.checked = input.value === thumbType;
        });
        
        if (customImageGroup) {
          customImageGroup.style.display = thumbType === 'custom' ? 'block' : 'none';
        }
      }
    } else {
      editingLinkId = null;
      if (modalTitle) modalTitle.textContent = 'Add Link';
      if (titleInput) titleInput.value = '';
      if (urlInput) urlInput.value = '';
      if (imageInput) imageInput.value = '';
      if (activeInput) activeInput.checked = true;
      thumbTypeInputs[0].checked = true; // platform default
      if (customImageGroup) customImageGroup.style.display = 'none';
    }
    
    updatePreview();
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('active'), 10);
  }

  // Close modal
  function closeModal() {
    if (!modal) return;
    modal.classList.remove('active');
    setTimeout(() => {
      modal.style.display = 'none';
    }, 200);
  }

  // Update preview
  function updatePreview() {
    const title = titleInput?.value || 'Link Title';
    const url = urlInput?.value || 'https://example.com';
    const selectedThumbType = Array.from(thumbTypeInputs).find(i => i.checked)?.value || 'platform';
    const customUrl = imageInput?.value?.trim();
    
    if (previewTitle) previewTitle.textContent = title;
    if (previewUrl) previewUrl.textContent = getDomain(url);
    if (previewIcon) {
      previewIcon.innerHTML = '';
      
      if (selectedThumbType === 'favicon') {
        const faviconUrl = getFaviconUrl(url);
        if (faviconUrl) {
          const img = document.createElement('img');
          img.src = faviconUrl;
          img.style.width = '24px';
          img.style.height = '24px';
          img.style.borderRadius = '4px';
          
          const span = document.createElement('span');
          span.className = 'material-symbols-outlined';
          span.textContent = getPlatformIconName(url);
          span.style.display = 'none';
          
          img.onerror = () => {
            img.style.display = 'none';
            span.style.display = 'block';
          };
          
          previewIcon.appendChild(img);
          previewIcon.appendChild(span);
        } else {
          const span = document.createElement('span');
          span.className = 'material-symbols-outlined';
          span.textContent = getPlatformIconName(url);
          previewIcon.appendChild(span);
        }
      } else if (selectedThumbType === 'preview') {
        const previewUrl = `https://s1.wp.com/mshots/v1/${encodeURIComponent(url)}?w=200`;
        const img = document.createElement('img');
        img.src = previewUrl;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '10px';
        
        const span = document.createElement('span');
        span.className = 'material-symbols-outlined';
        span.textContent = 'visibility';
        span.style.display = 'none';
        
        img.onerror = () => {
          img.style.display = 'none';
          span.style.display = 'block';
        };
        
        previewIcon.appendChild(img);
        previewIcon.appendChild(span);
      } else if (selectedThumbType === 'custom' && customUrl) {
        const img = document.createElement('img');
        img.src = customUrl;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '10px';
        
        const span = document.createElement('span');
        span.className = 'material-symbols-outlined';
        span.textContent = 'image';
        span.style.display = 'none';
        
        img.onerror = () => {
          img.style.display = 'none';
          span.style.display = 'block';
        };
        
        previewIcon.appendChild(img);
        previewIcon.appendChild(span);
      } else {
        const span = document.createElement('span');
        span.className = 'material-symbols-outlined';
        span.textContent = getPlatformIconName(url);
        previewIcon.appendChild(span);
      }
    }
  }

  // Save link
  function saveLink() {
    const title = titleInput?.value?.trim();
    const url = urlInput?.value?.trim();
    const isActive = activeInput?.checked ?? true;
    const thumbnailType = (Array.from(thumbTypeInputs).find(i => i.checked)?.value || 'platform') as any;
    const thumbnailUrl = imageInput?.value?.trim() || undefined;
    
    if (!title || !url) {
      alert('Please fill in both title and URL');
      return;
    }
    
    try {
      new URL(url);
    } catch {
      alert('Please enter a valid URL');
      return;
    }
    
    if (editingLinkId) {
      const index = links.findIndex(l => l.id === editingLinkId);
      if (index !== -1) {
        links[index] = { ...links[index], title, url, isActive, thumbnailType, thumbnailUrl };
      }
    } else {
      if (links.length >= 10) {
        alert('Maximum 10 links allowed');
        return;
      }
      links.push({
        id: crypto.randomUUID(),
        title,
        url,
        order: links.length,
        isActive,
        thumbnailType,
        thumbnailUrl
      });
    }
    
    renderLinks();
    closeModal();
    saveToClerk();
    
    // Dispatch event for live preview
    document.dispatchEvent(new CustomEvent('links-updated', { detail: [...links] }));
  }

  // Delete link
  function deleteLink(id: string) {
    if (confirm('Are you sure you want to delete this link?')) {
      links = links.filter(l => l.id !== id);
      links.forEach((link, i) => link.order = i);
      renderLinks();
      saveToClerk();
      
      // Dispatch event for live preview
      document.dispatchEvent(new CustomEvent('links-updated', { detail: [...links] }));
    }
  }

  // Drag and drop handlers
  function handleDragStart(e: DragEvent) {
    draggedItem = e.target as HTMLElement;
    if (draggedItem) {
      draggedItem.classList.add('dragging');
      e.dataTransfer!.effectAllowed = 'move';
    }
  }

  function handleDragEnd(e: DragEvent) {
    if (draggedItem) {
      draggedItem.classList.remove('dragging');
      draggedItem = null;
    }
    
    // Update links order based on DOM
    const container = document.getElementById('links-container');
    if (container) {
      const cards = container.querySelectorAll('.link-card');
      const newLinks: Link[] = [];
      cards.forEach((card, index) => {
        const id = card.getAttribute('data-id');
        const link = links.find(l => l.id === id);
        if (link) {
          newLinks.push({ ...link, order: index });
        }
      });
      links = newLinks;
      saveToClerk();
      
      // Dispatch event for live preview
      document.dispatchEvent(new CustomEvent('links-updated', { detail: [...links] }));
    }
  }

  function handleDragOver(e: DragEvent) {
    e.preventDefault();
    e.dataTransfer!.dropEffect = 'move';
    
    const container = document.getElementById('links-container');
    if (!container || !draggedItem) return;
    
    const afterElement = getDragAfterElement(container, e.clientY);
    if (afterElement == null) {
      container.appendChild(draggedItem);
    } else {
      container.insertBefore(draggedItem, afterElement);
    }
  }

  function getDragAfterElement(container: HTMLElement, y: number): HTMLElement | null {
    const draggableElements = [...container.querySelectorAll('.link-card:not(.dragging)')] as HTMLElement[];
    
    const result = draggableElements.reduce<{ offset: number; element: HTMLElement | null }>((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      
      if (offset < 0 && offset > closest.offset) {
        return { offset: offset, element: child };
      } else {
        return closest;
      }
    }, { offset: Number.NEGATIVE_INFINITY, element: null });

    return result.element;
  }

  // Render links
  function renderLinks() {
    const container = document.getElementById('links-container');
    const template = document.getElementById('link-card-template') as HTMLTemplateElement;
    const emptyTemplate = document.getElementById('empty-state-template') as HTMLTemplateElement;
    
    if (!container || !template || !emptyTemplate) return;
    
    container.textContent = '';
    
    if (links.length === 0) {
      container.appendChild(emptyTemplate.content.cloneNode(true));
      return;
    }
    
    links.forEach((link, index) => {
      const clone = template.content.cloneNode(true) as DocumentFragment;
      const card = clone.querySelector('.link-card') as HTMLElement;
      
      card.setAttribute('data-id', link.id);
      card.setAttribute('data-index', index.toString());
      
      const number = card.querySelector('.link-number') as HTMLElement;
      number.textContent = `#${index + 1}`;
      
      const editBtn = card.querySelector('.btn-edit-link') as HTMLElement;
      editBtn.setAttribute('data-id', link.id);
      editBtn.onclick = () => openModal(link.id);
      
      const deleteBtn = card.querySelector('.btn-delete-link') as HTMLElement;
      deleteBtn.setAttribute('data-id', link.id);
      deleteBtn.onclick = () => deleteLink(link.id);
      
      const iconContainer = card.querySelector('.preview-icon') as HTMLElement;
      iconContainer.textContent = '';
      
      const thumbType = link.thumbnailType || 'platform';
      
      if (thumbType === 'favicon') {
        const faviconUrl = getFaviconUrl(link.url);
        if (faviconUrl) {
          const img = document.createElement('img');
          img.src = faviconUrl;
          img.className = 'preview-favicon';
          img.style.width = '20px';
          img.style.height = '20px';
          img.style.borderRadius = '4px';
          
          const span = document.createElement('span');
          span.className = 'material-symbols-outlined';
          span.textContent = getPlatformIconName(link.url);
          span.style.display = 'none';
          
          img.onerror = () => {
            img.style.display = 'none';
            span.style.display = 'block';
          };
          
          iconContainer.appendChild(img);
          iconContainer.appendChild(span);
        } else {
          const span = document.createElement('span');
          span.className = 'material-symbols-outlined';
          span.textContent = getPlatformIconName(link.url);
          iconContainer.appendChild(span);
        }
      } else if (thumbType === 'preview') {
        const previewUrl = `https://s1.wp.com/mshots/v1/${encodeURIComponent(link.url)}?w=200`;
        const img = document.createElement('img');
        img.src = previewUrl;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '8px';
        
        const span = document.createElement('span');
        span.className = 'material-symbols-outlined';
        span.textContent = 'visibility';
        span.style.display = 'none';
        
        img.onerror = () => {
          img.style.display = 'none';
          span.style.display = 'block';
        };
        
        iconContainer.appendChild(img);
        iconContainer.appendChild(span);
      } else if (thumbType === 'custom' && link.thumbnailUrl) {
        const img = document.createElement('img');
        img.src = link.thumbnailUrl;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '8px';
        
        const span = document.createElement('span');
        span.className = 'material-symbols-outlined';
        span.textContent = 'image';
        span.style.display = 'none';
        
        img.onerror = () => {
          img.style.display = 'none';
          span.style.display = 'block';
        };
        
        iconContainer.appendChild(img);
        iconContainer.appendChild(span);
      } else {
        const span = document.createElement('span');
        span.className = 'material-symbols-outlined';
        span.textContent = getPlatformIconName(link.url);
        iconContainer.appendChild(span);
      }
      
      const title = card.querySelector('.preview-title') as HTMLElement;
      title.textContent = link.title;
      
      const url = card.querySelector('.preview-url') as HTMLElement;
      url.textContent = getDomain(link.url);
      
      card.addEventListener('dragstart', (((e: DragEvent) => handleDragStart(e)) as any));
      card.addEventListener('dragend', (((e: DragEvent) => handleDragEnd(e)) as any));
      
      container.appendChild(clone);
    });
  }


  // Save to Clerk
  async function saveToClerk() {
    try {
      // Use the global save function from dashboard if available
      const globalSave = (window as any).saveToClerkFromEditor;
      if (globalSave) {
        await globalSave();
        return;
      }

      // Fallback to direct API call if not in dashboard
      const usernameInput = document.getElementById('username') as HTMLInputElement;
      const displayNameInput = document.getElementById('displayName') as HTMLInputElement;
      const bioInput = document.getElementById('bio') as HTMLTextAreaElement;
      
      await fetch('/api/profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: usernameInput?.value || '',
          displayName: displayNameInput?.value || '',
          bio: bioInput?.value || '',
          links: links
        })
      });
    } catch (error) {
      console.error('Error saving:', error);
    }
  }

  // Event listeners
  document.getElementById('add-link-btn')?.addEventListener('click', () => openModal());
  document.getElementById('close-modal')?.addEventListener('click', closeModal);
  document.getElementById('cancel-link-btn')?.addEventListener('click', closeModal);
  document.getElementById('save-link-btn')?.addEventListener('click', saveLink);
  document.querySelector('.modal-backdrop')?.addEventListener('click', closeModal);
  
  titleInput?.addEventListener('input', updatePreview);
  urlInput?.addEventListener('click', updatePreview);
  urlInput?.addEventListener('input', updatePreview);
  imageInput?.addEventListener('input', updatePreview);

  thumbTypeInputs.forEach(input => {
    input.addEventListener('change', () => {
      if (customImageGroup) {
        customImageGroup.style.display = input.value === 'custom' ? 'block' : 'none';
      }
      updatePreview();
    });
  });

  // Enable drag and drop on container
  if (linksContainer) {
    linksContainer.addEventListener('dragover', handleDragOver);
  }

  // Initialize drag events for existing cards
  renderLinks();
</script>


