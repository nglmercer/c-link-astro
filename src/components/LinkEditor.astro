---
interface Link {
  id: string;
  title: string;
  url: string;
  icon?: string;
  order: number;
  isActive: boolean;
}

interface Props {
  links: Link[];
}

const { links = [] } = Astro.props;

// Helper functions for the template
function getPlatformIcon(url: string): string {
  const domain = url.replace(/^https?:\/\//, '').replace(/^www\./, '').split('/')[0].toLowerCase();
  
  if (domain.includes('github')) return 'code';
  if (domain.includes('twitter') || domain.includes('x.com')) return 'tag';
  if (domain.includes('instagram')) return 'photo_camera';
  if (domain.includes('youtube')) return 'play_circle';
  if (domain.includes('linkedin')) return 'work';
  if (domain.includes('tiktok')) return 'music_note';
  if (domain.includes('discord')) return 'chat';
  if (domain.includes('twitch')) return 'sports_esports';
  if (domain.includes('reddit')) return 'forum';
  if (domain.includes('medium')) return 'article';
  return 'link';
}

function getDomain(url: string): string {
  try {
    return new URL(url).hostname.replace('www.', '');
  } catch {
    return url;
  }
}
---

<div class="link-editor">
  <div class="editor-header">
    <h3>Links</h3>
    <span class="link-count">{links.length} / 10 links</span>
  </div>

  <div id="links-container" class="links-container">
    {links.length === 0 ? (
      <div class="empty-state">
        <span class="material-symbols-outlined empty-icon">link_off</span>
        <p>No links yet</p>
        <span>Add your first link to get started</span>
      </div>
    ) : (
      links.map((link, index) => (
        <div class="link-card" data-id={link.id} data-index={index} draggable="true">
          <div class="link-card-header">
            <div class="drag-handle" title="Drag to reorder">
              <span class="material-symbols-outlined">drag_indicator</span>
            </div>
            <span class="link-number">#{index + 1}</span>
            <button class="btn-edit-link" data-id={link.id} title="Edit">
              <span class="material-symbols-outlined">edit</span>
            </button>
            <button class="btn-delete-link" data-id={link.id} title="Delete">
              <span class="material-symbols-outlined">delete</span>
            </button>
          </div>
          
          <div class="link-preview-mini">
            <div class="preview-icon">
              <span class="material-symbols-outlined">{getPlatformIcon(link.url)}</span>
            </div>
            <div class="preview-content">
              <span class="preview-title">{link.title}</span>
              <span class="preview-url">{getDomain(link.url)}</span>
            </div>
            <span class="material-symbols-outlined external-icon">open_in_new</span>
          </div>
        </div>
      ))
    )}
  </div>

  <button id="add-link-btn" class="add-link-btn">
    <span class="material-symbols-outlined">add</span>
    Add Link
  </button>

  <!-- Link Editor Modal -->
  <div id="link-modal" class="modal">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">Add Link</h3>
        <button id="close-modal" class="close-btn">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label for="link-title-input">Title</label>
          <input type="text" id="link-title-input" placeholder="My Website" />
        </div>
        
        <div class="form-group">
          <label for="link-url-input">URL</label>
          <input type="url" id="link-url-input" placeholder="https://example.com" />
        </div>
        
        <div class="link-preview-section">
          <label>Preview</label>
          <div class="preview-card">
            <div class="preview-card-icon" id="preview-card-icon">
              <span class="material-symbols-outlined">link</span>
            </div>
            <div class="preview-card-content">
              <span class="preview-card-title" id="preview-title-display">Link Title</span>
              <span class="preview-card-url" id="preview-url-display">https://example.com</span>
            </div>
            <span class="material-symbols-outlined external-arrow">open_in_new</span>
          </div>
        </div>
        
        <div class="form-row">
          <label class="toggle-label">
            <input type="checkbox" id="link-active" checked />
            <span class="toggle-text">Active</span>
          </label>
        </div>
      </div>
      
      <div class="modal-footer">
        <button id="cancel-link-btn" class="btn-cancel">Cancel</button>
        <button id="save-link-btn" class="btn-save">Save Link</button>
      </div>
    </div>
  </div>
</div>

<script>
  interface Link {
    id: string;
    title: string;
    url: string;
    order: number;
    isActive: boolean;
  }

  let links: Link[] = [];
  let editingLinkId: string | null = null;
  let draggedItem: HTMLElement | null = null;

  // Initialize with data from server
  const linksContainer = document.getElementById('links-container');
  if (linksContainer) {
    const linkCards = linksContainer.querySelectorAll('.link-card');
    links = Array.from(linkCards).map((card) => ({
      id: card.getAttribute('data-id') || '',
      title: card.querySelector('.preview-title')?.textContent || '',
      url: card.querySelector('.preview-url')?.textContent || '',
      order: parseInt(card.getAttribute('data-index') || '0'),
      isActive: true
    }));
  }

  // Modal elements
  const modal = document.getElementById('link-modal') as HTMLElement;
  const modalTitle = document.getElementById('modal-title');
  const titleInput = document.getElementById('link-title-input') as HTMLInputElement;
  const urlInput = document.getElementById('link-url-input') as HTMLInputElement;
  const activeInput = document.getElementById('link-active') as HTMLInputElement;
  const previewTitle = document.getElementById('preview-title-display');
  const previewUrl = document.getElementById('preview-url-display');
  const previewIcon = document.getElementById('preview-card-icon');

  // Get domain from URL
  function getDomain(url: string): string {
    try {
      const urlObj = new URL(url);
      return urlObj.hostname.replace('www.', '');
    } catch {
      return url;
    }
  }

  // Get platform icon name
  function getPlatformIconName(url: string): string {
    const domain = getDomain(url).toLowerCase();
    
    if (domain.includes('github')) return 'code';
    if (domain.includes('twitter') || domain.includes('x.com')) return 'tag';
    if (domain.includes('instagram')) return 'photo_camera';
    if (domain.includes('youtube')) return 'play_circle';
    if (domain.includes('linkedin')) return 'work';
    if (domain.includes('tiktok')) return 'music_note';
    if (domain.includes('discord')) return 'chat';
    if (domain.includes('twitch')) return 'sports_esports';
    if (domain.includes('reddit')) return 'forum';
    if (domain.includes('medium')) return 'article';
    return 'link';
  }

  // Open modal
  function openModal(linkId?: string) {
    if (!modal) return;
    
    if (linkId) {
      const link = links.find(l => l.id === linkId);
      if (link) {
        editingLinkId = linkId;
        if (modalTitle) modalTitle.textContent = 'Edit Link';
        if (titleInput) titleInput.value = link.title;
        if (urlInput) urlInput.value = link.url;
        if (activeInput) activeInput.checked = link.isActive;
      }
    } else {
      editingLinkId = null;
      if (modalTitle) modalTitle.textContent = 'Add Link';
      if (titleInput) titleInput.value = '';
      if (urlInput) urlInput.value = '';
      if (activeInput) activeInput.checked = true;
    }
    
    updatePreview();
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('active'), 10);
  }

  // Close modal
  function closeModal() {
    if (!modal) return;
    modal.classList.remove('active');
    setTimeout(() => {
      modal.style.display = 'none';
    }, 200);
  }

  // Update preview
  function updatePreview() {
    const title = titleInput?.value || 'Link Title';
    const url = urlInput?.value || 'https://example.com';
    
    if (previewTitle) previewTitle.textContent = title;
    if (previewUrl) previewUrl.textContent = getDomain(url);
    if (previewIcon) {
      previewIcon.innerHTML = `<span class="material-symbols-outlined">${getPlatformIconName(url)}</span>`;
    }
  }

  // Save link
  function saveLink() {
    const title = titleInput?.value?.trim();
    const url = urlInput?.value?.trim();
    const isActive = activeInput?.checked ?? true;
    
    if (!title || !url) {
      alert('Please fill in both title and URL');
      return;
    }
    
    try {
      new URL(url);
    } catch {
      alert('Please enter a valid URL');
      return;
    }
    
    if (editingLinkId) {
      const index = links.findIndex(l => l.id === editingLinkId);
      if (index !== -1) {
        links[index] = { ...links[index], title, url, isActive };
      }
    } else {
      if (links.length >= 10) {
        alert('Maximum 10 links allowed');
        return;
      }
      links.push({
        id: Date.now().toString(),
        title,
        url,
        order: links.length,
        isActive
      });
    }
    
    renderLinks();
    closeModal();
    saveToClerk();
  }

  // Delete link
  function deleteLink(id: string) {
    if (confirm('Are you sure you want to delete this link?')) {
      links = links.filter(l => l.id !== id);
      links.forEach((link, i) => link.order = i);
      renderLinks();
      saveToClerk();
    }
  }

  // Drag and drop handlers
  function handleDragStart(e: DragEvent) {
    draggedItem = e.target as HTMLElement;
    if (draggedItem) {
      draggedItem.classList.add('dragging');
      e.dataTransfer!.effectAllowed = 'move';
    }
  }

  function handleDragEnd(e: DragEvent) {
    if (draggedItem) {
      draggedItem.classList.remove('dragging');
      draggedItem = null;
    }
    
    // Update links order based on DOM
    const container = document.getElementById('links-container');
    if (container) {
      const cards = container.querySelectorAll('.link-card');
      const newLinks: Link[] = [];
      cards.forEach((card, index) => {
        const id = card.getAttribute('data-id');
        const link = links.find(l => l.id === id);
        if (link) {
          newLinks.push({ ...link, order: index });
        }
      });
      links = newLinks;
      saveToClerk();
    }
  }

  function handleDragOver(e: DragEvent) {
    e.preventDefault();
    e.dataTransfer!.dropEffect = 'move';
    
    const container = document.getElementById('links-container');
    if (!container || !draggedItem) return;
    
    const afterElement = getDragAfterElement(container, e.clientY);
    if (afterElement == null) {
      container.appendChild(draggedItem);
    } else {
      container.insertBefore(draggedItem, afterElement);
    }
  }

  function getDragAfterElement(container: HTMLElement, y: number) {
    const draggableElements = [...container.querySelectorAll('.link-card:not(.dragging)')] as HTMLElement[];
    
    return draggableElements.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      
      if (offset < 0 && offset > closest.offset) {
        return { offset: offset, element: child };
      } else {
        return closest;
      }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  // Render links
  function renderLinks() {
    const container = document.getElementById('links-container');
    if (!container) return;
    
    if (links.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <span class="material-symbols-outlined empty-icon">link_off</span>
          <p>No links yet</p>
          <span>Add your first link to get started</span>
        </div>
      `;
      return;
    }
    
    container.innerHTML = links.map((link, index) => `
      <div class="link-card" data-id="${link.id}" data-index="${index}" draggable="true">
        <div class="link-card-header">
          <div class="drag-handle" title="Drag to reorder">
            <span class="material-symbols-outlined">drag_indicator</span>
          </div>
          <span class="link-number">#${index + 1}</span>
          <button class="btn-edit-link" data-id="${link.id}" title="Edit">
            <span class="material-symbols-outlined">edit</span>
          </button>
          <button class="btn-delete-link" data-id="${link.id}" title="Delete">
            <span class="material-symbols-outlined">delete</span>
          </button>
        </div>
        
        <div class="link-preview-mini">
          <div class="preview-icon">
            <span class="material-symbols-outlined">${getPlatformIconName(link.url)}</span>
          </div>
          <div class="preview-content">
            <span class="preview-title">${escapeHtml(link.title)}</span>
            <span class="preview-url">${getDomain(link.url)}</span>
          </div>
          <span class="material-symbols-outlined external-icon">open_in_new</span>
        </div>
      </div>
    `).join('');
    
    // Add event listeners
    container.querySelectorAll('.link-card').forEach(card => {
      card.addEventListener('dragstart', handleDragStart);
      card.addEventListener('dragend', handleDragEnd);
    });
    
    container.querySelectorAll('.btn-edit-link').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = (e.currentTarget as HTMLElement).getAttribute('data-id');
        if (id) openModal(id);
      });
    });
    
    container.querySelectorAll('.btn-delete-link').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = (e.currentTarget as HTMLElement).getAttribute('data-id');
        if (id) deleteLink(id);
      });
    });
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Save to Clerk
  async function saveToClerk() {
    try {
      const usernameInput = document.getElementById('username') as HTMLInputElement;
      const displayNameInput = document.getElementById('displayName') as HTMLInputElement;
      const bioInput = document.getElementById('bio') as HTMLTextAreaElement;
      
      await fetch('/api/profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: usernameInput?.value || '',
          displayName: displayNameInput?.value || '',
          bio: bioInput?.value || '',
          links: links
        })
      });
    } catch (error) {
      console.error('Error saving:', error);
    }
  }

  // Event listeners
  document.getElementById('add-link-btn')?.addEventListener('click', () => openModal());
  document.getElementById('close-modal')?.addEventListener('click', closeModal);
  document.getElementById('cancel-link-btn')?.addEventListener('click', closeModal);
  document.getElementById('save-link-btn')?.addEventListener('click', saveLink);
  document.querySelector('.modal-backdrop')?.addEventListener('click', closeModal);
  
  titleInput?.addEventListener('input', updatePreview);
  urlInput?.addEventListener('click', updatePreview);
  urlInput?.addEventListener('input', updatePreview);

  // Enable drag and drop on container
  if (linksContainer) {
    linksContainer.addEventListener('dragover', handleDragOver);
  }

  // Initialize drag events for existing cards
  renderLinks();
</script>

<style>
  .link-editor {
    background: white;
    border-radius: 16px;
    border: 1px solid #e5e7eb;
    overflow: hidden;
  }

  .editor-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .editor-header h3 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
  }

  .link-count {
    font-size: 0.85rem;
    color: #6b7280;
    background: #f3f4f6;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
  }

  .links-container {
    padding: 1rem;
    min-height: 200px;
  }

  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #6b7280;
  }

  .empty-icon {
    font-size: 3rem;
    margin-bottom: 0.75rem;
    color: #9ca3af;
  }

  .empty-state p {
    margin: 0 0 0.25rem;
    font-weight: 500;
    color: #374151;
  }

  .empty-state span {
    font-size: 0.875rem;
  }

  .link-card {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    margin-bottom: 0.75rem;
    overflow: hidden;
    transition: all 0.2s;
    cursor: grab;
  }

  .link-card:hover {
    border-color: #d1d5db;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .link-card.dragging {
    opacity: 0.5;
    cursor: grabbing;
  }

  .link-card-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: white;
    border-bottom: 1px solid #f3f4f6;
  }

  .drag-handle {
    cursor: grab;
    color: #9ca3af;
    display: flex;
    align-items: center;
  }

  .drag-handle:active {
    cursor: grabbing;
  }

  .link-number {
    font-size: 0.75rem;
    font-weight: 600;
    color: #9ca3af;
    margin-right: auto;
  }

  .btn-edit-link, .btn-delete-link {
    background: transparent;
    border: none;
    padding: 0.375rem;
    cursor: pointer;
    color: #6b7280;
    border-radius: 6px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .btn-edit-link:hover {
    background: #f3f4f6;
    color: #2563eb;
  }

  .btn-delete-link:hover {
    background: #fee2e2;
    color: #ef4444;
  }

  .link-preview-mini {
    display: flex;
    align-items: center;
    gap: 0.875rem;
    padding: 1rem;
  }

  .preview-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border-radius: 10px;
    color: #374151;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .preview-icon .material-symbols-outlined {
    font-size: 20px;
  }

  .preview-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
    min-width: 0;
  }

  .preview-title {
    font-weight: 500;
    color: #111;
    font-size: 0.95rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .preview-url {
    font-size: 0.8rem;
    color: #6b7280;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .external-icon {
    color: #9ca3af;
    font-size: 18px;
  }

  .add-link-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    width: calc(100% - 2rem);
    margin: 0 1rem 1rem;
    padding: 0.875rem;
    background: white;
    border: 2px dashed #d1d5db;
    border-radius: 12px;
    color: #6b7280;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .add-link-btn:hover {
    border-color: #2563eb;
    color: #2563eb;
    background: #f0f7ff;
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .modal.active {
    display: flex;
    opacity: 1;
  }

  .modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
  }

  .modal-content {
    position: relative;
    background: white;
    border-radius: 16px;
    width: 90%;
    max-width: 480px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .modal-header h3 {
    margin: 0;
    font-size: 1.25rem;
  }

  .close-btn {
    background: transparent;
    border: none;
    padding: 0.5rem;
    cursor: pointer;
    color: #6b7280;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .close-btn:hover {
    background: #f3f4f6;
  }

  .modal-body {
    padding: 1.5rem;
  }

  .form-group {
    margin-bottom: 1.25rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #374151;
    font-size: 0.95rem;
  }

  .form-group input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid #d1d5db;
    border-radius: 10px;
    font-size: 1rem;
    transition: border-color 0.2s;
    box-sizing: border-box;
  }

  .form-group input:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .link-preview-section {
    margin-bottom: 1.25rem;
  }

  .link-preview-section label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #374151;
    font-size: 0.95rem;
  }

  .preview-card {
    display: flex;
    align-items: center;
    gap: 0.875rem;
    padding: 1rem;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
  }

  .preview-card-icon {
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border-radius: 10px;
    color: #374151;
    flex-shrink: 0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .preview-card-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
    min-width: 0;
  }

  .preview-card-title {
    font-weight: 500;
    color: #111;
  }

  .preview-card-url {
    font-size: 0.8rem;
    color: #6b7280;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .external-arrow {
    color: #9ca3af;
    flex-shrink: 0;
  }

  .form-row {
    display: flex;
    align-items: center;
  }

  .toggle-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
  }

  .toggle-label input {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .toggle-text {
    font-size: 0.95rem;
    color: #374151;
  }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    padding: 1.25rem 1.5rem;
    border-top: 1px solid #e5e7eb;
  }

  .btn-cancel {
    padding: 0.625rem 1.25rem;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    color: #374151;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
  }

  .btn-cancel:hover {
    background: #f3f4f6;
  }

  .btn-save {
    padding: 0.625rem 1.25rem;
    background: #2563eb;
    border: none;
    border-radius: 8px;
    color: white;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
  }

  .btn-save:hover {
    background: #1d4ed8;
  }
</style>
