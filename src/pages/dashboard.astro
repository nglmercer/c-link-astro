---
import Layout from '../layouts/Layout.astro'
import { SignedIn, SignedOut, SignInButton } from '@clerk/astro/components'
import { clerkClient } from '@clerk/astro/server'
import ProfileForm from '../components/ProfileForm.astro'
import LinkEditor from '../components/LinkEditor.astro'
import ProfilePreview from '../components/ProfilePreview.astro'
import type { UserProfile } from '../types/linktree'

import { findUserById, findUserByUsername } from '../lib/profile.server'

// Get user ID from Clerk auth via locals
const clerkAuth = Astro.locals.auth()
const userId = clerkAuth?.userId

// Get user profile from Clerk API for defaults
let clerkUser = null
if (userId) {
  try {
    const client = clerkClient(Astro)
    clerkUser = await client.users.getUser(userId)
  } catch (e) {
    console.error('Error fetching user from Clerk:', e)
  }
}

const defaultName = clerkUser ? `${clerkUser.firstName || ''} ${clerkUser.lastName || ''}`.trim() : ''
const defaultAvatar = clerkUser?.imageUrl || ''

// Get user profile from Astro DB
let profile: UserProfile | null = null
let username = ''

if (userId) {
  try {
    profile = await findUserById(userId)
    if (profile) {
      username = profile.username
    } else {
      // Logic for generating a unique default username
      const email = clerkUser?.emailAddresses[0]?.emailAddress || ''
      let baseUsername = email.split('@')[0] || 'user'
      baseUsername = baseUsername.toLowerCase().replace(/[^a-z0-9_-]/g, '')
      
      // Check if base exists
      const existing = await findUserByUsername(baseUsername)
      if (!existing) {
        username = baseUsername
      } else {
        // Find a random available one
        username = `${baseUsername}${Math.floor(100 + Math.random() * 900)}`
      }
    }
  } catch (e) {
    console.error('Error fetching user from DB:', e)
    username = userId?.slice(0, 12) || 'user'
  }
}

// Pre-load links from profile for SSR
const initialLinks = profile?.links || []
const hasClaimedUsername = !!profile?.username
---

<Layout title="Dashboard - C-Link">
  <SignedOut>
    <div class="auth-prompt">
      <div class="auth-card">
        <div class="auth-icon">ðŸ”—</div>
        <h2>Welcome to C-Link</h2>
        <p>Create your personal link tree and share all your links in one place.</p>
        <SignInButton mode="modal">
          <button class="btn-primary">Sign In to Get Started</button>
        </SignInButton>
      </div>
    </div>
  </SignedOut>

  <SignedIn>
    <div 
      class="dashboard" 
      data-default-avatar={defaultAvatar}
      data-initial-avatar={profile?.avatarUrl || defaultAvatar}
      data-initial-theme={profile?.theme || 'gradient'}
    >
      <div class="dashboard-header">
        <div class="header-info">
          <h1>My C-Link</h1>
          <p>Manage your personal link tree and profile identity.</p>
        </div>
        <div class="header-actions">
          <a href={`/${username}`} target="_blank" class="btn-profile-link">
            <span class="material-symbols-outlined">link</span>
            <span>c-link.com/{username}</span>
            <span class="material-symbols-outlined share-icon">open_in_new</span>
          </a>
        </div>
      </div>

      {!hasClaimedUsername && (
        <div class="claim-banner">
          <div class="claim-content">
            <h3>ðŸŽ‰ Claim your username!</h3>
            <p>Set up your unique link tree URL now.</p>
          </div>
        </div>
      )}

      <div class="dashboard-grid">
        <div class="section profile-section">
          <h2>Profile</h2>
          <ProfileForm 
            username={username}
            displayName={profile?.displayName || defaultName}
            bio={profile?.bio || 'Manage your personal link tree and profile identity.'}
            avatarUrl={profile?.avatarUrl || defaultAvatar}
            theme={profile?.theme}
          />
        </div>

        <div class="section links-section">
          <LinkEditor links={initialLinks} />
        </div>

        <div class="section preview-section">
          <ProfilePreview username={username} />
        </div>
      </div>

      <div class="save-bar">
        <button id="save-btn" class="btn-save">
          <span class="btn-text">Save Changes</span>
          <span class="btn-loading">Saving...</span>
        </button>
        <span id="save-status" class="save-status"></span>
      </div>
    </div>
  </SignedIn>
</Layout>

<script>
  // Import store from lib - this will be bundled with the page
  import { saveProfile, checkUsername } from '../lib/store';
  import type { Link } from '../types/linktree';

  // State
  let isCheckingUsername = false;
  let checkTimeout: ReturnType<typeof setTimeout> | null = null;
  let currentLinks: Link[] = JSON.parse(document.getElementById('links-container')?.getAttribute('data-initial-links') || '[]');
  const dashboard = document.querySelector('.dashboard') as HTMLElement;
  let currentTheme = dashboard?.getAttribute('data-initial-theme') || 'gradient';
  let currentAvatar = dashboard?.getAttribute('data-initial-avatar') || '';

  // Expose for preview iframe
  (window as any).currentLinks = currentLinks;
  (window as any).currentTheme = currentTheme;
  (window as any).currentAvatar = currentAvatar;

  // Elements
  const usernameInput = document.getElementById('username') as HTMLInputElement;
  const usernameStatus = document.getElementById('username-status');
  const saveBtn = document.getElementById('save-btn') as HTMLButtonElement;
  const saveStatus = document.getElementById('save-status');

  // Check username availability
  async function checkUsernameAvailability(username: string) {
    if (!username || username.length < 3) return;
    
    if (checkTimeout) clearTimeout(checkTimeout);
    
    checkTimeout = setTimeout(async () => {
      if (isCheckingUsername) return;
      
      isCheckingUsername = true;
      if (usernameStatus) {
        usernameStatus.textContent = 'Checking...';
        usernameStatus.className = 'username-status checking';
      }
      
      try {
        const result = await checkUsername(username);
        
        if (result.available) {
          if (usernameStatus) {
            usernameStatus.textContent = 'âœ“ Username is available!';
            usernameStatus.className = 'username-status available';
          }
        } else {
          if (usernameStatus) {
            usernameStatus.textContent = 'âœ— ' + (result.reason || 'Username is taken');
            usernameStatus.className = 'username-status taken';
          }
        }
      } catch (error) {
        console.error('Error checking username:', error);
      } finally {
        isCheckingUsername = false;
      }
    }, 500);
  }

  // Username input handler
  if (usernameInput) {
    usernameInput.addEventListener('input', (e: Event) => {
      const target = e.target as HTMLInputElement;
      const value = target.value.trim();
      if (value.length >= 3) {
        checkUsernameAvailability(value);
      } else if (usernameStatus) {
        usernameStatus.textContent = '';
        usernameStatus.className = 'username-status';
      }
    });
  }

  // Save to Clerk
  async function saveToClerk() {
    try {
      if (saveBtn) saveBtn.disabled = true;
      if (saveStatus) {
        saveStatus.textContent = 'Saving...';
        saveStatus.className = 'save-status saving';
      }
      
      const usernameVal = usernameInput?.value?.trim() || '';
      const displayNameInput = document.getElementById('displayName') as HTMLInputElement;
      const bioInput = document.getElementById('bio') as HTMLTextAreaElement;
      
      const result = await saveProfile({
        username: usernameVal,
        displayName: displayNameInput?.value?.trim() || '',
        bio: bioInput?.value?.trim() || '',
        avatarUrl: currentAvatar,
        theme: (currentTheme as any) || undefined,
        links: currentLinks
      });
      
      if (result) {
        if (saveStatus) {
          saveStatus.textContent = 'Saved!';
          saveStatus.className = 'save-status success';
        }
        
        // Update preview link
        const previewLink = document.querySelector('.btn-view') as HTMLAnchorElement;
        if (previewLink && result.username) {
          previewLink.href = `/${result.username}`;
        }
        
        // Hide claim banner
        const banner = document.querySelector('.claim-banner') as HTMLElement;
        if (banner && result.username) {
          banner.style.display = 'none';
        }
      } else {
        throw new Error('Failed to save');
      }
    } catch (error) {
      console.error('Error saving:', error);
      if (saveStatus) {
        saveStatus.textContent = 'Error saving';
        saveStatus.className = 'save-status error';
      }
    } finally {
      if (saveBtn) saveBtn.disabled = false;
      setTimeout(() => {
        if (saveStatus) {
          saveStatus.textContent = '';
          saveStatus.className = 'save-status';
        }
      }, 3000);
    }
  }

  // Expose saveToClerk globally for LinkEditor component
  (window as unknown as { saveToClerkFromEditor: typeof saveToClerk }).saveToClerkFromEditor = saveToClerk;

  // Listen for links updates from LinkEditor
  document.addEventListener('links-updated', (e: Event) => {
    const customEvent = e as CustomEvent<Link[]>;
    currentLinks = customEvent.detail;
    (window as any).currentLinks = currentLinks;
  });

  // Listen for theme updates from ProfileForm
  document.addEventListener('theme-updated', (e: Event) => {
    const customEvent = e as CustomEvent<string>;
    currentTheme = customEvent.detail;
    (window as any).currentTheme = currentTheme;
  });

  // Save button
  document.getElementById('save-btn')?.addEventListener('click', saveToClerk);
</script>

<style>
  .auth-prompt {
    min-height: 80vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  .auth-card {
    text-align: center;
    max-width: 400px;
    padding: 3rem 2rem;
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  }

  .auth-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  .auth-card h2 {
    margin: 0 0 0.5rem;
    font-size: 1.75rem;
  }

  .auth-card p {
    color: #6b7280;
    margin: 0 0 1.5rem;
  }

  .btn-primary {
    background: #2563eb;
    color: white;
    border: none;
    padding: 0.875rem 2rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: background 0.2s;
  }

  .btn-primary:hover {
    background: #1d4ed8;
  }

  .dashboard {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
    background: #fdfdfd;
    min-height: calc(100vh - 80px);
  }

  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin-bottom: 3rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #f3f4f6;
  }

  .header-info h1 {
    margin: 0 0 0.5rem;
    font-size: 2rem;
    font-weight: 800;
    color: #111827;
    letter-spacing: -0.02em;
  }

  .header-info p {
    margin: 0;
    color: #6b7280;
    font-size: 1rem;
  }

  .btn-profile-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background: white;
    color: #374151;
    border: 1px solid #e5e7eb;
    padding: 0.75rem 1.25rem;
    border-radius: 14px;
    text-decoration: none;
    font-size: 0.95rem;
    font-weight: 600;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }

  .btn-profile-link:hover {
    border-color: #d1d5db;
    background: #f9fafb;
    transform: translateY(-1px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
  }

  .btn-profile-link .share-icon {
    font-size: 1.1rem;
    color: #9ca3af;
  }

  .claim-banner {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
  }

  .claim-content h3 {
    margin: 0 0 0.25rem;
    font-size: 1.1rem;
  }

  .claim-content p {
    margin: 0;
    opacity: 0.9;
  }

  .dashboard-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
  }

  @media (min-width: 1200px) {
    .dashboard-grid {
      grid-template-columns: 1.1fr 1.3fr 340px;
    }
  }

  @media (min-width: 768px) and (max-width: 1199px) {
    .dashboard-grid {
      grid-template-columns: 1fr 1fr;
    }
    
    .preview-section {
      grid-column: span 2;
      display: flex;
      justify-content: center;
    }
  }

  .section {
    background: white;
    border-radius: 28px;
    padding: 2.25rem;
    box-shadow: 
      0 1px 3px rgba(0, 0, 0, 0.05),
      0 20px 25px -5px rgba(0, 0, 0, 0.03);
    border: 1px solid rgba(0, 0, 0, 0.05);
    height: fit-content;
  }

  .section h2 {
    margin: 0 0 2rem;
    font-size: 1.5rem;
    font-weight: 800;
    color: #111827;
    display: flex;
    align-items: center;
    gap: 0.875rem;
    letter-spacing: -0.02em;
  }

  .save-bar {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-top: 2rem;
    padding: 1.25rem 2rem;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-radius: 20px;
    position: sticky;
    bottom: 1.5rem;
    box-shadow: 
      0 -4px 6px -1px rgba(0, 0, 0, 0.02),
      0 10px 40px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.5);
    z-index: 50;
  }

  .btn-save {
    background: #10b981;
    color: white;
    border: none;
    padding: 0.875rem 2.5rem;
    border-radius: 14px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 700;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
  }

  .btn-save:hover {
    background: #059669;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
  }

  .btn-save:disabled {
    background: #9ca3af;
    cursor: not-allowed;
  }

  .btn-text, .btn-loading {
    display: none;
  }

  .btn-save:not(:disabled) .btn-text {
    display: inline;
  }

  .btn-save:disabled .btn-loading {
    display: inline;
  }

  .save-status {
    font-size: 0.9rem;
  }

  .save-status.success {
    color: #10b981;
    font-weight: 600;
  }

  .save-status.error {
    color: #ef4444;
    font-weight: 600;
  }

  .save-status.saving {
    color: #6b7280;
  }
</style>
