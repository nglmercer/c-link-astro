---
import Layout from '../layouts/Layout.astro'
import { SignedIn, SignedOut, SignInButton } from '@clerk/astro/components'
import { clerkClient } from '@clerk/astro/server'
import ProfileForm from '../components/ProfileForm.astro'
import LinkEditor from '../components/LinkEditor.astro'
import type { UserProfile } from '../types/linktree'

// Get user ID from Clerk auth via locals
const clerkAuth = Astro.locals.auth()
const userId = clerkAuth?.userId
const clerk = clerkClient(Astro)

// Get user profile from Clerk metadata
let profile: UserProfile | undefined
let username = 'user'

if (userId) {
  try {
    const user = await clerk.users.getUser(userId)
    const metadata = user.publicMetadata as Record<string, any>
    profile = metadata?.profile
    username = profile?.username || userId.slice(0, 12)
  } catch (e) {
    console.error('Error fetching user:', e)
    username = userId.slice(0, 12)
  }
}

// Pre-load links from profile for SSR
const initialLinks = profile?.links || []
const hasClaimedUsername = !!profile?.username
---

<Layout title="Dashboard - C-Link">
  <SignedOut>
    <div class="auth-prompt">
      <div class="auth-card">
        <div class="auth-icon">ðŸ”—</div>
        <h2>Welcome to C-Link</h2>
        <p>Create your personal link tree and share all your links in one place.</p>
        <SignInButton mode="modal">
          <button class="btn-primary">Sign In to Get Started</button>
        </SignInButton>
      </div>
    </div>
  </SignedOut>

  <SignedIn>
    <div class="dashboard">
      <div class="dashboard-header">
        <div class="header-content">
          <h1>Dashboard</h1>
          <p>Manage your profile and links</p>
        </div>
        <div class="header-actions">
          <a href={`/${username}`} target="_blank" class="btn-view">
            View Profile â†’
          </a>
        </div>
      </div>

      {!hasClaimedUsername && (
        <div class="claim-banner">
          <div class="claim-content">
            <h3>ðŸŽ‰ Claim your username!</h3>
            <p>Set up your unique link tree URL now.</p>
          </div>
        </div>
      )}

      <div class="dashboard-grid">
        <div class="section profile-section">
          <h2>Profile</h2>
          <ProfileForm 
            username={username}
            displayName={profile?.displayName}
            bio={profile?.bio}
          />
        </div>

        <div class="section links-section">
          <LinkEditor links={initialLinks} />
        </div>
      </div>

      <div class="save-bar">
        <button id="save-btn" class="btn-save">
          <span class="btn-text">Save Changes</span>
          <span class="btn-loading">Saving...</span>
        </button>
        <span id="save-status" class="save-status"></span>
      </div>
    </div>
  </SignedIn>
</Layout>

<script define:vars={{ hasClaimedUsername }}>
  let currentUsername = hasClaimedUsername ? '' : null
  
  // Username availability check
  let isCheckingUsername = false
  let checkTimeout = null

  const usernameInput = document.getElementById('username')
  const usernameStatus = document.getElementById('username-status')
  const saveBtn = document.getElementById('save-btn')
  const saveStatus = document.getElementById('save-status')

  // Check username
  async function checkUsername(username) {
    if (!username || username.length < 3) return
    
    if (checkTimeout) clearTimeout(checkTimeout)
    
    checkTimeout = setTimeout(async () => {
      if (isCheckingUsername) return
      
      isCheckingUsername = true
      if (usernameStatus) {
        usernameStatus.textContent = 'Checking...'
        usernameStatus.className = 'username-status checking'
      }
      
      try {
        const response = await fetch(`/api/profile/check?username=${encodeURIComponent(username)}`)
        const data = await response.json()
        
        if (data.available) {
          if (usernameStatus) {
            usernameStatus.textContent = 'âœ“ Username is available!'
            usernameStatus.className = 'username-status available'
          }
        } else {
          if (usernameStatus) {
            usernameStatus.textContent = 'âœ— ' + (data.reason || 'Username is taken')
            usernameStatus.className = 'username-status taken'
          }
        }
      } catch (error) {
        console.error('Error checking username:', error)
      } finally {
        isCheckingUsername = false
      }
    }, 500)
  }

  // Username input handler
  if (usernameInput) {
    usernameInput.addEventListener('input', (e) => {
      const value = e.target.value.trim()
      if (value.length >= 3) {
        checkUsername(value)
      } else if (usernameStatus) {
        usernameStatus.textContent = ''
        usernameStatus.className = 'username-status'
      }
    })
  }

  // Save to Clerk
  async function saveToClerk() {
    try {
      if (saveBtn) saveBtn.disabled = true
      if (saveStatus) {
        saveStatus.textContent = 'Saving...'
        saveStatus.className = 'save-status saving'
      }
      
      const usernameVal = usernameInput?.value?.trim() || ''
      const displayNameInput = document.getElementById('displayName')
      const bioInput = document.getElementById('bio')
      
      const response = await fetch('/api/profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: usernameVal,
          displayName: displayNameInput?.value?.trim() || '',
          bio: bioInput?.value?.trim() || ''
        })
      })
      
      const data = await response.json()
      
      if (data.success) {
        currentUsername = data.profile.username
        
        if (saveStatus) {
          saveStatus.textContent = 'Saved!'
          saveStatus.className = 'save-status success'
        }
        
        // Update preview link
        const previewLink = document.querySelector('.btn-view')
        if (previewLink && currentUsername) {
          previewLink.setAttribute('href', `/${currentUsername}`)
        }
        
        // Hide claim banner
        const banner = document.querySelector('.claim-banner')
        if (banner && currentUsername) {
          banner.style.display = 'none'
        }
      } else {
        throw new Error(data.error || 'Failed to save')
      }
    } catch (error) {
      console.error('Error saving:', error)
      if (saveStatus) {
        saveStatus.textContent = 'Error saving'
        saveStatus.className = 'save-status error'
      }
    } finally {
      if (saveBtn) saveBtn.disabled = false
      setTimeout(() => {
        if (saveStatus) {
          saveStatus.textContent = ''
          saveStatus.className = 'save-status'
        }
      }, 3000)
    }
  }

  // Save button
  document.getElementById('save-btn')?.addEventListener('click', saveToClerk)
</script>

<style>
  .auth-prompt {
    min-height: 80vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  .auth-card {
    text-align: center;
    max-width: 400px;
    padding: 3rem 2rem;
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  }

  .auth-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  .auth-card h2 {
    margin: 0 0 0.5rem;
    font-size: 1.75rem;
  }

  .auth-card p {
    color: #6b7280;
    margin: 0 0 1.5rem;
  }

  .btn-primary {
    background: #2563eb;
    color: white;
    border: none;
    padding: 0.875rem 2rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: background 0.2s;
  }

  .btn-primary:hover {
    background: #1d4ed8;
  }

  .dashboard {
    max-width: 1000px;
    margin: 0 auto;
    padding: 2rem;
  }

  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
  }

  .header-content h1 {
    margin: 0 0 0.25rem;
    font-size: 1.75rem;
  }

  .header-content p {
    margin: 0;
    color: #6b7280;
  }

  .btn-view {
    background: white;
    color: #374151;
    border: 1px solid #d1d5db;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s;
  }

  .btn-view:hover {
    background: #f3f4f6;
    border-color: #9ca3af;
  }

  .claim-banner {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
  }

  .claim-content h3 {
    margin: 0 0 0.25rem;
    font-size: 1.1rem;
  }

  .claim-content p {
    margin: 0;
    opacity: 0.9;
  }

  .dashboard-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
  }

  @media (min-width: 768px) {
    .dashboard-grid {
      grid-template-columns: 1fr 1fr;
    }
  }

  .section {
    background: #f9fafb;
    border-radius: 12px;
    padding: 1.5rem;
  }

  .section h2 {
    margin: 0 0 1rem;
    font-size: 1.1rem;
    color: #111;
  }

  .save-bar {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-top: 1.5rem;
    padding: 1rem;
    background: white;
    border-radius: 12px;
    position: sticky;
    bottom: 1rem;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
  }

  .btn-save {
    background: #10b981;
    color: white;
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: background 0.2s;
  }

  .btn-save:hover {
    background: #059669;
  }

  .btn-save:disabled {
    background: #9ca3af;
    cursor: not-allowed;
  }

  .btn-text, .btn-loading {
    display: none;
  }

  .btn-save:not(:disabled) .btn-text {
    display: inline;
  }

  .btn-save:disabled .btn-loading {
    display: inline;
  }

  .save-status {
    font-size: 0.9rem;
  }

  .save-status.success {
    color: #10b981;
  }

  .save-status.error {
    color: #ef4444;
  }

  .save-status.saving {
    color: #6b7280;
  }
</style>
