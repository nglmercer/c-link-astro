---
import Layout from '../layouts/Layout.astro'
import { SignedIn, SignedOut, SignInButton } from '@clerk/astro/components'
import { clerkClient } from '@clerk/astro/server'
import type { UserProfile } from '../types/linktree'

// Get user ID from Clerk auth via locals
const clerkAuth = Astro.locals.auth()
const userId = clerkAuth?.userId
const clerk = clerkClient(Astro)

// Get user profile from Clerk metadata
let profile: UserProfile | undefined
let username = 'user'

if (userId) {
  try {
    const user = await clerk.users.getUser(userId)
    const metadata = user.publicMetadata as Record<string, any>
    profile = metadata?.profile
    username = profile?.username || userId.slice(0, 12)
  } catch (e) {
    console.error('Error fetching user:', e)
    username = userId.slice(0, 12)
  }
}

// Pre-load links from profile for SSR
const initialLinks = profile?.links || []
---

<Layout title="Dashboard - Link Tree">
  <SignedOut>
    <div class="auth-prompt">
      <h2>Sign in to access your dashboard</h2>
      <SignInButton mode="modal">
        <button class="btn-primary">Sign In</button>
      </SignInButton>
    </div>
  </SignedOut>

  <SignedIn>
    <div class="dashboard">
      <div class="dashboard-header">
        <h1>Link Tree Dashboard</h1>
        <p>Manage your links and customize your profile</p>
      </div>

      <div class="profile-section">
        <h2>Profile Settings</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" value={username} placeholder="Enter your username" />
            <p class="hint">Your link tree will be available at: <code id="preview-url">/{username}</code></p>
          </div>
          <div class="form-group">
            <label for="displayName">Display Name</label>
            <input type="text" id="displayName" value={profile?.displayName || username} placeholder="Your display name" />
          </div>
        </div>
        <div class="form-group">
          <label for="bio">Bio</label>
          <textarea id="bio" placeholder="Tell people about yourself" rows="3">{profile?.bio || ''}</textarea>
        </div>
        <button id="save-profile-btn" class="btn-secondary">Save Profile</button>
        <span id="save-status" class="save-status"></span>
      </div>

      <div class="links-section">
        <h2>Your Links</h2>
        <div id="links-list" class="links-list" data-user-id={userId}>
        </div>
        
        <div class="add-link-form">
          <h3>Add New Link</h3>
          <div class="form-row">
            <input type="text" id="link-title" placeholder="Link Title" />
            <input type="url" id="link-url" placeholder="https://example.com" />
            <button id="add-link-btn" class="btn-primary">Add Link</button>
          </div>
        </div>
      </div>

      <div class="preview-section">
        <h2>Preview</h2>
        <a href={`/${username}`} target="_blank" class="preview-link">
          View your public page â†’
        </a>
      </div>
    </div>
  </SignedIn>
</Layout>

<script define:vars={{ initialLinks, username }}>
  // Client-side state management synced with Clerk
  let links = initialLinks || []
  let currentUsername = username
  let currentDisplayName = username
  let currentBio = ''

  // Load from initial data
  if (initialLinks && initialLinks.length > 0) {
    links = initialLinks
  }

  // Save profile to Clerk
  async function saveToClerk() {
    const statusEl = document.getElementById('save-status')
    const saveBtn = document.getElementById('save-profile-btn')
    
    try {
      if (saveBtn) saveBtn.disabled = true
      if (statusEl) statusEl.textContent = 'Saving...'
      
      const usernameInput = document.getElementById('username') as HTMLInputElement
      const displayNameInput = document.getElementById('displayName') as HTMLInputElement
      const bioInput = document.getElementById('bio') as HTMLTextAreaElement
      
      const response = await fetch('/api/profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: usernameInput?.value || currentUsername,
          displayName: displayNameInput?.value || currentDisplayName,
          bio: bioInput?.value || currentBio,
          links: links
        })
      })
      
      const data = await response.json()
      
      if (data.success) {
        if (statusEl) {
          statusEl.textContent = 'Saved!'
          statusEl.className = 'save-status success'
        }
        currentUsername = data.profile.username
        currentDisplayName = data.profile.displayName
        currentBio = data.profile.bio
        
        // Update preview URL
        const previewUrl = document.getElementById('preview-url')
        if (previewUrl) {
          previewUrl.textContent = `/${currentUsername}`
        }
      } else {
        throw new Error(data.error || 'Failed to save')
      }
    } catch (error) {
      console.error('Error saving:', error)
      if (statusEl) {
        statusEl.textContent = 'Error saving'
        statusEl.className = 'save-status error'
      }
    } finally {
      if (saveBtn) saveBtn.disabled = false
      setTimeout(() => {
        if (statusEl) {
          statusEl.textContent = ''
          statusEl.className = 'save-status'
        }
      }, 2000)
    }
  }

  // Render links list
  function renderLinks() {
    const container = document.getElementById('links-list')
    if (!container) return

    if (links.length === 0) {
      container.innerHTML = '<p class="empty">No links yet. Add your first link above!</p>'
      return
    }

    container.innerHTML = links.map((link, index) => `
      <div class="link-item">
        <div class="link-info">
          <strong>${escapeHtml(link.title)}</strong>
          <span class="link-url">${escapeHtml(link.url)}</span>
        </div>
        <button class="btn-delete" data-index="${index}">Delete</button>
      </div>
    `).join('')

    // Add event listeners to delete buttons
    container.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const index = parseInt((e.target as HTMLElement).getAttribute('data-index') || '0')
        deleteLink(index)
      })
    })
  }

  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    const div = document.createElement('div')
    div.textContent = text
    return div.innerHTML
  }

  // Add new link
  document.getElementById('add-link-btn')?.addEventListener('click', () => {
    const titleInput = document.getElementById('link-title') as HTMLInputElement
    const urlInput = document.getElementById('link-url') as HTMLInputElement
    
    const title = titleInput?.value.trim()
    const url = urlInput?.value.trim()

    if (!title || !url) {
      alert('Please fill in both title and URL')
      return
    }

    // Add to links array
    links.push({ 
      id: Date.now().toString(),
      title, 
      url, 
      order: links.length,
      isActive: true 
    })
    
    titleInput.value = ''
    urlInput.value = ''
    renderLinks()
    
    // Save to Clerk
    saveToClerk()
  })

  // Delete link
  function deleteLink(index) {
    links.splice(index, 1)
    // Reorder
    links.forEach((link, i) => link.order = i)
    renderLinks()
    
    // Save to Clerk
    saveToClerk()
  }

  // Save profile button
  document.getElementById('save-profile-btn')?.addEventListener('click', saveToClerk)

  // Update username preview
  document.getElementById('username')?.addEventListener('input', (e) => {
    const target = e.target as HTMLInputElement
    const preview = document.getElementById('preview-url')
    if (preview) {
      preview.textContent = `/${target.value || 'username'}`
    }
  })

  // Initial render
  renderLinks()
</script>

<style>
  .auth-prompt {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
    gap: 1.5rem;
    text-align: center;
  }

  .dashboard {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem;
  }

  .dashboard-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .dashboard-header h1 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }

  .dashboard-header p {
    color: #666;
  }

  .profile-section, .links-section, .preview-section {
    background: #f9f9f9;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .profile-section h2, .links-section h2, .preview-section h2 {
    margin-top: 0;
    margin-bottom: 1rem;
    font-size: 1.25rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    flex: 1;
  }

  .form-group label {
    font-weight: 600;
  }

  .form-group input, .form-group textarea {
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    font-family: inherit;
    resize: vertical;
  }

  .hint {
    font-size: 0.875rem;
    color: #666;
  }

  .hint code {
    background: #e9e9e9;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
  }

  .form-row {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
  }

  .form-row input {
    flex: 1;
    min-width: 150px;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
  }

  .btn-primary {
    background: #2563eb;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: background 0.2s;
  }

  .btn-primary:hover {
    background: #1d4ed8;
  }

  .btn-secondary {
    background: #10b981;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: background 0.2s;
  }

  .btn-secondary:hover {
    background: #059669;
  }

  .btn-secondary:disabled {
    background: #9ca3af;
    cursor: not-allowed;
  }

  .save-status {
    margin-left: 1rem;
    font-size: 0.875rem;
    transition: all 0.2s;
  }

  .save-status.success {
    color: #10b981;
  }

  .save-status.error {
    color: #ef4444;
  }

  .links-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .link-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid #eee;
  }

  .link-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .link-url {
    font-size: 0.875rem;
    color: #666;
  }

  .btn-delete {
    background: #ef4444;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.875rem;
    transition: background 0.2s;
  }

  .btn-delete:hover {
    background: #dc2626;
  }

  .add-link-form h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    font-size: 1rem;
  }

  .empty {
    color: #666;
    font-style: italic;
    text-align: center;
    padding: 2rem;
  }

  .preview-link {
    display: inline-block;
    background: #10b981;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    transition: background 0.2s;
  }

  .preview-link:hover {
    background: #059669;
  }

  @media (max-width: 600px) {
    .dashboard {
      padding: 1rem;
    }

    .form-row {
      flex-direction: column;
    }

    .link-item {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .btn-delete {
      width: 100%;
    }
  }
</style>
