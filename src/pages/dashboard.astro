---
import Layout from '../layouts/Layout.astro'
import { SignedIn, SignedOut, SignInButton } from '@clerk/astro/components'
import { clerkClient } from '@clerk/astro/server'
import ProfileForm from '../components/ProfileForm.astro'
import LinkEditor from '../components/LinkEditor.astro'
import ProfilePreview from '../components/ProfilePreview.astro'
import type { UserProfile } from '../types/linktree'

import { findUserById, findUserByUsername } from '../lib/profile.server'

// Get user ID from Clerk auth via locals
const clerkAuth = Astro.locals.auth()
const userId = clerkAuth?.userId

// Get user profile from Clerk API for defaults
let clerkUser = null
if (userId) {
  try {
    const client = clerkClient(Astro)
    clerkUser = await client.users.getUser(userId)
  } catch (e) {
    console.error('Error fetching user from Clerk:', e)
  }
}

const defaultName = clerkUser ? `${clerkUser.firstName || ''} ${clerkUser.lastName || ''}`.trim() : ''
const defaultAvatar = clerkUser?.imageUrl || ''

// Get user profile from Astro DB
let profile: UserProfile | null = null
let username = ''

if (userId) {
  try {
    profile = await findUserById(userId)
    if (profile) {
      username = profile.username
    } else {
      // Logic for generating a unique default username
      const email = clerkUser?.emailAddresses[0]?.emailAddress || ''
      let baseUsername = email.split('@')[0] || 'user'
      baseUsername = baseUsername.toLowerCase().replace(/[^a-z0-9_-]/g, '')
      
      // Check if base exists
      const existing = await findUserByUsername(baseUsername)
      if (!existing) {
        username = baseUsername
      } else {
        // Find a random available one
        username = `${baseUsername}${Math.floor(100 + Math.random() * 900)}`
      }
    }
  } catch (e) {
    console.error('Error fetching user from DB:', e)
    username = userId?.slice(0, 12) || 'user'
  }
}

// Pre-load links from profile for SSR
const initialLinks = profile?.links || []
const hasClaimedUsername = !!profile?.username
---

<Layout title="Dashboard - C-Link">
  <SignedOut>
    <div class="auth-prompt">
      <div class="auth-card">
        <div class="auth-icon">ðŸ”—</div>
        <h2>Welcome to C-Link</h2>
        <p>Create your personal link tree and share all your links in one place.</p>
        <SignInButton mode="modal">
          <button class="btn-primary">Sign In to Get Started</button>
        </SignInButton>
      </div>
    </div>
  </SignedOut>

  <SignedIn>
    <div 
      class="dashboard" 
      data-default-avatar={defaultAvatar}
      data-initial-avatar={profile?.avatarUrl || defaultAvatar}
      data-initial-theme={profile?.theme || 'gradient'}
    >
      <div class="dashboard-header">
        <div class="header-info">
          <h1>My C-Link</h1>
          <p>Manage your personal link tree and profile identity.</p>
        </div>
        <div class="header-actions">
          <a href={`/${username}`} target="_blank" class="btn-profile-link">
            <span class="material-symbols-outlined">link</span>
            <span>c-link.com/{username}</span>
            <span class="material-symbols-outlined share-icon">open_in_new</span>
          </a>
        </div>
      </div>

      {!hasClaimedUsername && (
        <div class="claim-banner">
          <div class="claim-content">
            <h3>ðŸŽ‰ Claim your username!</h3>
            <p>Set up your unique link tree URL now.</p>
          </div>
        </div>
      )}

      <div class="dashboard-grid">
        <div class="section profile-section">
          <h2>Profile</h2>
          <ProfileForm 
            username={username}
            displayName={profile?.displayName || defaultName}
            bio={profile?.bio || 'Manage your personal link tree and profile identity.'}
            avatarUrl={profile?.avatarUrl || defaultAvatar}
            theme={profile?.theme}
          />
        </div>

        <div class="section links-section">
          <LinkEditor links={initialLinks} />
        </div>

        <div class="section preview-section">
          <ProfilePreview username={username} />
        </div>
      </div>

      <div class="save-bar">
        <button id="save-btn" class="btn-save">
          <span class="btn-text">Save Changes</span>
          <span class="btn-loading">Saving...</span>
        </button>
        <span id="save-status" class="save-status"></span>
      </div>
    </div>
  </SignedIn>
</Layout>

<script>
  // Import store from lib - this will be bundled with the page
  import { saveProfile, checkUsername } from '../lib/store';
  import type { Link } from '../types/linktree';

  // State
  let isCheckingUsername = false;
  let checkTimeout: ReturnType<typeof setTimeout> | null = null;
  let currentLinks: Link[] = JSON.parse(document.getElementById('links-container')?.getAttribute('data-initial-links') || '[]');
  const dashboard = document.querySelector('.dashboard') as HTMLElement;
  let currentTheme = dashboard?.getAttribute('data-initial-theme') || 'gradient';
  let currentAvatar = dashboard?.getAttribute('data-initial-avatar') || '';

  // Expose for preview iframe
  (window as any).currentLinks = currentLinks;
  (window as any).currentTheme = currentTheme;
  (window as any).currentAvatar = currentAvatar;

  // Elements
  const usernameInput = document.getElementById('username') as HTMLInputElement;
  const usernameStatus = document.getElementById('username-status');
  const saveBtn = document.getElementById('save-btn') as HTMLButtonElement;
  const saveStatus = document.getElementById('save-status');

  // Check username availability
  async function checkUsernameAvailability(username: string) {
    if (!username || username.length < 3) return;
    
    if (checkTimeout) clearTimeout(checkTimeout);
    
    checkTimeout = setTimeout(async () => {
      if (isCheckingUsername) return;
      
      isCheckingUsername = true;
      if (usernameStatus) {
        usernameStatus.textContent = 'Checking...';
        usernameStatus.className = 'username-status checking';
      }
      
      try {
        const result = await checkUsername(username);
        
        if (result.available) {
          if (usernameStatus) {
            usernameStatus.textContent = 'âœ“ Username is available!';
            usernameStatus.className = 'username-status available';
          }
        } else {
          if (usernameStatus) {
            usernameStatus.textContent = 'âœ— ' + (result.reason || 'Username is taken');
            usernameStatus.className = 'username-status taken';
          }
        }
      } catch (error) {
        console.error('Error checking username:', error);
      } finally {
        isCheckingUsername = false;
      }
    }, 500);
  }

  // Username input handler
  if (usernameInput) {
    usernameInput.addEventListener('input', (e: Event) => {
      const target = e.target as HTMLInputElement;
      const value = target.value.trim();
      if (value.length >= 3) {
        checkUsernameAvailability(value);
      } else if (usernameStatus) {
        usernameStatus.textContent = '';
        usernameStatus.className = 'username-status';
      }
    });
  }

  // Save to Clerk
  async function saveToClerk() {
    try {
      if (saveBtn) saveBtn.disabled = true;
      if (saveStatus) {
        saveStatus.textContent = 'Saving...';
        saveStatus.className = 'save-status saving';
      }
      
      const usernameVal = usernameInput?.value?.trim() || '';
      const displayNameInput = document.getElementById('displayName') as HTMLInputElement;
      const bioInput = document.getElementById('bio') as HTMLTextAreaElement;
      
      const result = await saveProfile({
        username: usernameVal,
        displayName: displayNameInput?.value?.trim() || '',
        bio: bioInput?.value?.trim() || '',
        avatarUrl: currentAvatar,
        theme: (currentTheme as any) || undefined,
        links: currentLinks
      });
      
      if (result) {
        if (saveStatus) {
          saveStatus.textContent = 'Saved!';
          saveStatus.className = 'save-status success';
        }
        
        // Update preview link
        const previewLink = document.querySelector('.btn-view') as HTMLAnchorElement;
        if (previewLink && result.username) {
          previewLink.href = `/${result.username}`;
        }
        
        // Hide claim banner
        const banner = document.querySelector('.claim-banner') as HTMLElement;
        if (banner && result.username) {
          banner.style.display = 'none';
        }
      } else {
        throw new Error('Failed to save');
      }
    } catch (error) {
      console.error('Error saving:', error);
      if (saveStatus) {
        saveStatus.textContent = 'Error saving';
        saveStatus.className = 'save-status error';
      }
    } finally {
      if (saveBtn) saveBtn.disabled = false;
      setTimeout(() => {
        if (saveStatus) {
          saveStatus.textContent = '';
          saveStatus.className = 'save-status';
        }
      }, 3000);
    }
  }

  // Expose saveToClerk globally for LinkEditor component
  (window as unknown as { saveToClerkFromEditor: typeof saveToClerk }).saveToClerkFromEditor = saveToClerk;

  // Listen for links updates from LinkEditor
  document.addEventListener('links-updated', (e: Event) => {
    const customEvent = e as CustomEvent<Link[]>;
    currentLinks = customEvent.detail;
    (window as any).currentLinks = currentLinks;
  });

  // Listen for theme updates from ProfileForm
  document.addEventListener('theme-updated', (e: Event) => {
    const customEvent = e as CustomEvent<string>;
    currentTheme = customEvent.detail;
    (window as any).currentTheme = currentTheme;
  });

  // Save button
  document.getElementById('save-btn')?.addEventListener('click', saveToClerk);
</script>


